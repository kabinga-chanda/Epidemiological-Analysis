"Water" = water,
"Cakes" = cakes,
"Vanilla Ice Cream" = vanilla.ice.cream,
"Chocolate Ice Cream" = chocolate.ice.cream,
"Fruit Salad" = fruit.salad
)
att_rat_data_long <- att_rat_data |>
pivot_longer(
cols = 8:21,
names_to = "food_item",
values_to = "exposed"
) |> select(food_item, exposed, ill)
att_rat_data_long |>
group_by(food_item) |>
summarise("Ill" = sum(ill == "1"),
"Not Ill"  = sum(ill == "0"),
"Attack Rate" = Ill/nrow(data_clean))
att_rat_summary <- att_rat_data_long |>
group_by(food_item) |>
summarise(
Ill_exposed = sum(exposed == "Y" & ill == "1", na.rm = TRUE),
NotIll_exposed = sum(exposed == "Y" & ill == "0", na.rm = TRUE),
Ill_not_exposed = sum(exposed == "N" & ill == "1", na.rm = TRUE),
NotIll_not_exposed = sum(exposed == "N" & ill == "0", na.rm = TRUE),
.groups = "drop"
)
att_rat_summary <- att_rat_summary |>
mutate(
Total_exposed = Ill_exposed + NotIll_exposed,
Total_not_exposed = Ill_not_exposed + NotIll_not_exposed,
AR_exposed = round(Ill_exposed / Total_exposed * 100,2),
AR_not_exposed = round(Ill_not_exposed / Total_not_exposed * 100,2),
Attack_Rate_Ratio = round(AR_exposed / AR_not_exposed, 2)
)
att_rat_summary <- att_rat_summary |>
arrange(desc(Attack_Rate_Ratio))
#| echo: false
#| message: false
#| warning: false
att_rat_summary |>
gt() |>
tab_header(
title = md("**Food-specific Attack Rate Table**"),
subtitle = "Oswego County Outbreak Investigation, 1940"
) |>
# Add spanners
tab_spanner(
label = md("**Ate Food**"),
columns = c(Ill_exposed, NotIll_exposed, Total_exposed, AR_exposed)
) |>
tab_spanner(
label = md("**Did Not Eat Food**"),
columns = c(Ill_not_exposed, NotIll_not_exposed, Total_not_exposed, AR_not_exposed)
) |>
cols_label(
food_item = md("**Food Item**"),
Ill_exposed = md("**Ill**"),
NotIll_exposed = md("**Not Ill**"),
Total_exposed = md("**Total**"),
AR_exposed = md("**Attack<br> Rate (%)**"),
Ill_not_exposed = md("**Ill**"),
NotIll_not_exposed = md("**Not Ill**"),
Total_not_exposed = md("**Total**"),
AR_not_exposed = md("**Attack<br> Rate (%)**"),
Attack_Rate_Ratio = md("**Attack Rate<br> Ratio**")
) |>
fmt_number(
columns = c(AR_exposed, AR_not_exposed, Attack_Rate_Ratio),
decimals = 1
) |>
tab_source_note(
source_note = "AR = Attack Rate; Exposure = Ate the food (Y/N)"
) |>
opt_align_table_header(align = "left") |>
tab_options(
table.border.top.style = "solid",
table.border.bottom.style = "solid",
column_labels.border.bottom.style = "solid",
table_body.hlines.style = "none",
table_body.vlines.style = "none"
)
att_rat_summary |>
ggplot(aes(x = reorder(food_item, Attack_Rate_Ratio), y = Attack_Rate_Ratio)) +
geom_col(fill = "thistle",
color = "black") +
coord_flip() +
labs(y = "Attack Rate Ratio", x = "Food Item")+
theme(panel.background = element_blank(),
axis.line.x = element_line(),
panel.grid.major.x = element_line(color = "grey",
size = 0.04)
)
### Stratied by Sex
# Step 1: Pivot foods to long format
att_rat_data_long <- data_clean |>
pivot_longer(
cols = baked.ham:fruit.salad,   # all food columns
names_to = "food_item",
values_to = "exposed"
)
# Step 2: Calculate stratified attack rates by sex
att_rat_sex <- att_rat_data_long |>
group_by(food_item, sex) |>
summarise(
Ill_exposed = sum(exposed == "Y" & ill == 1, na.rm = TRUE),
NotIll_exposed = sum(exposed == "Y" & ill == 0, na.rm = TRUE),
Ill_not_exposed = sum(exposed == "N" & ill == 1, na.rm = TRUE),
NotIll_not_exposed = sum(exposed == "N" & ill == 0, na.rm = TRUE),
Total_exposed = Ill_exposed + NotIll_exposed,
Total_not_exposed = Ill_not_exposed + NotIll_not_exposed,
AR_exposed = round(Ill_exposed / Total_exposed * 100, 1),
AR_not_exposed = round(Ill_not_exposed / Total_not_exposed * 100, 1),
Attack_Rate_Ratio = round(AR_exposed / AR_not_exposed, 2),
.groups = "drop"
) |>
arrange(food_item, sex)
# Create a named vector for nicer food names
food_names <- c(
"baked.ham" = "Baked Ham",
"brown.bread" = "Brown Bread",
"cabbage.salad" = "Cabbage Salad",
"cakes" = "Cakes",
"chocolate.ice.cream" = "Chocolate Ice Cream",
"coffee" = "Coffee",
"fruit.salad" = "Fruit Salad",
"jello" = "Jello",
"mashed.potato" = "Mashed Potato",
"milk" = "Milk",
"rolls" = "Rolls",
"spinach" = "Spinach",
"vanilla.ice.cream" = "Vanilla Ice Cream",
"water" = "Water"
)
# Apply nicer names to your table
att_rat_sex <- att_rat_sex |>
mutate(food_item = food_names[food_item])
# Step 3: Create a publication-ready table with gt
att_rat_sex |>
gt() |>
tab_header(
title = md("**Stratified Food-specific Attack Rates by Sex**"),
subtitle = "Oswego-style Outbreak Analysis"
) |>
tab_spanner(
label = md("**Ate Food**"),
columns = c(Ill_exposed, NotIll_exposed, Total_exposed, AR_exposed)
) |>
tab_spanner(
label = md("**Did Not Eat Food**"),
columns = c(Ill_not_exposed, NotIll_not_exposed, Total_not_exposed, AR_not_exposed)
) |>
cols_label(
food_item = md("**Food Item**"),
sex = "Sex",
Ill_exposed = md("**Ill**"),
NotIll_exposed =md("**Not Ill**"),
Total_exposed = md("**Total**"),
AR_exposed = md("**Attack<br> Rate (%)**"),
Ill_not_exposed = md("**Ill**"),
NotIll_not_exposed = md("**Not Ill**"),
Total_not_exposed = md("**Total**"),
AR_not_exposed = md("**Attack <br>Rate (%)**"),
Attack_Rate_Ratio = md("**Attack <br>Rate Ratio**")
) |>
fmt_number(
columns = c(AR_exposed, AR_not_exposed, Attack_Rate_Ratio),
decimals = 1
) |>
tab_source_note(
source_note = "AR = Attack Rate; Exposure = Ate the food (Y/N)"
) |>
tab_options(
table.border.top.style = "solid",
table.border.bottom.style = "solid",
column_labels.border.bottom.style = "solid",
table_body.hlines.style = "none",
table_body.vlines.style = "none"
)
#| message: false
#| warning: false
#| include: false
pacman::p_load(epitools,
tidyverse,
rio,
janitor,
gt,
gtsummary,
naniar,
epikit,
summarytools,
broom,
epiR,
brms,
cmdstanr,
hms
)
#| message: false
#| warning: false
#| include: false
data(oswego)
data <- oswego
# Re-code the variables
data_clean <- data |>
mutate(
across(8:21,
~ if_else(. == "Y", 1,
if_else(. == "N", 0, NA_real_)))
)
### Recode the ill var
data_clean <- data |>
mutate(
ill = if_else(ill == "Y", 1,
if_else(ill == "N", 0, NA_real_)),
sex = if_else(sex == "F", "Female", "Male"),
onset.datetime = mdy_hm(paste(onset.date, "2024", onset.time))
)
data_clean <- data_clean |>
mutate(
age_grp = age_categories(age,
by = 15,
lower = 3,
upper = 77),
meal.time_hms = hms::as_hms(parse_date_time(meal.time, orders = "I:M p")),
onset.time_hms = hms::as_hms(parse_date_time(onset.time, orders = "I:M p")),
# Create proper meal datetime
# If onset time < meal time, meal was the previous day
meal.datetime = if_else(
onset.time_hms < meal.time_hms,
onset.datetime - days(1) + (meal.time_hms - hms::as_hms(onset.datetime)),
onset.datetime - (onset.time_hms - meal.time_hms)
),
# Calculate incubation period in hours
incu_period_hours = as.numeric(difftime(onset.datetime, meal.datetime, units = "hours"))
)
#| echo: false
#| message: false
#| warning: false
# Characteristics and Demographics
data_clean |>
mutate(ill = if_else(ill == "1", "Ill", "Not Ill")) |>
select(-c(id,
onset.date,
onset.time,
age_grp,meal.time,
onset.datetime,
onset.time_hms,
meal.time_hms,
meal.datetime,
8:21)) |>
tbl_summary(by = ill,
type = incu_period_hours ~ "continuous",
digits = incu_period_hours ~ 1,
label = list(
age = "Age (In Years)",
sex = "Sex of the Participant",
incu_period_hours = "Incubation Period (In Hours)"),
missing = "no"
) |>
bold_labels() |>
add_overall(
col_label = "**Overall**  \nN = {style_number(N)}",
) |>
add_p() |>
as_gt() |>
tab_header(
title = md("**Outbreak of Gastrointestinal Illness in Oswego County, 1940**")
) |>
tab_source_note(
source_note = md("**Source:** Oswego An Outbreak of Gastrointestinal Illness Following a Church Supper<br>
(updated 2003):
*https://www.cdc.gov/eis/casestudies/xoswego.401-303.student.pdf*")
) |>
opt_align_table_header(align = "left") |>
tab_options(
table.border.top.style = "solid",
table.border.bottom.style = "solid",
column_labels.border.bottom.style = "solid",
table_body.hlines.style = "none",
table_body.vlines.style = "none"
)
#| echo: false
#| message: false
#| warning: false
# Create the Epidemic Curve
data_clean |>
mutate(ill = if_else(ill == 1, "Ill", "Not Ill")) |>
ggplot(aes(x = onset.datetime)) +
geom_histogram(fill = "thistle", bins = 30, color = "black") +
# Add shaded area for meal time period
annotate("rect",
xmin = min(data_clean$meal.datetime, na.rm = TRUE),
xmax = max(data_clean$meal.datetime, na.rm = TRUE),
ymin = 0, ymax = Inf,
alpha = 0.2, fill = "blue") +
annotate("text",
x = mean(data_clean$meal.datetime, na.rm = TRUE),
y = 10,
label = "Meal Period",
color = "darkblue",
fontface = "bold") +
scale_x_datetime(
date_breaks = "3 hours",
date_labels = "%m/%d %I:%M %p",
expand = expansion(mult = c(0.1, 0.1))
) +
labs(
title = "Epidemic Curve of Foodborne Illness Outbreak",
subtitle = paste0("Mean incubation period: ",
round(mean(data_clean$incu_period_hours, na.rm = TRUE), 1),
" hours"),
x = "Date and Time of Onset",
y = "Number of Cases"
) +
theme(
panel.background = element_blank(),
axis.line.x = element_line(color = "black"),
axis.text.x = element_text(angle = 45, hjust = 1),
panel.grid.major.y = element_line(linewidth = 0.3, color = "grey")
)
#| message: false
#| warning: false
#| include: false
# Attack Rates
att_rat_data <-  data_clean |>
rename(
"Baked Ham" = baked.ham,
"Spinach" = spinach,
"Mashed Potato" = mashed.potato,
"Cabbage Salad" = cabbage.salad,
"Jello" = jello,
"Rolls" = rolls,
"Brown Bread" = brown.bread,
"Milk" = milk,
"Coffee" = coffee,
"Water" = water,
"Cakes" = cakes,
"Vanilla Ice Cream" = vanilla.ice.cream,
"Chocolate Ice Cream" = chocolate.ice.cream,
"Fruit Salad" = fruit.salad
)
att_rat_data_long <- att_rat_data |>
pivot_longer(
cols = 8:21,
names_to = "food_item",
values_to = "exposed"
) |> select(food_item, exposed, ill)
att_rat_data_long |>
group_by(food_item) |>
summarise("Ill" = sum(ill == "1"),
"Not Ill"  = sum(ill == "0"),
"Attack Rate" = Ill/nrow(data_clean))
att_rat_summary <- att_rat_data_long |>
group_by(food_item) |>
summarise(
Ill_exposed = sum(exposed == "Y" & ill == "1", na.rm = TRUE),
NotIll_exposed = sum(exposed == "Y" & ill == "0", na.rm = TRUE),
Ill_not_exposed = sum(exposed == "N" & ill == "1", na.rm = TRUE),
NotIll_not_exposed = sum(exposed == "N" & ill == "0", na.rm = TRUE),
.groups = "drop"
)
att_rat_summary <- att_rat_summary |>
mutate(
Total_exposed = Ill_exposed + NotIll_exposed,
Total_not_exposed = Ill_not_exposed + NotIll_not_exposed,
AR_exposed = round(Ill_exposed / Total_exposed * 100,2),
AR_not_exposed = round(Ill_not_exposed / Total_not_exposed * 100,2),
Attack_Rate_Ratio = round(AR_exposed / AR_not_exposed, 2)
)
att_rat_summary <- att_rat_summary |>
arrange(desc(Attack_Rate_Ratio))
#| echo: false
#| message: false
#| warning: false
att_rat_summary |>
gt() |>
tab_header(
title = md("**Food-specific Attack Rate Table**"),
subtitle = "Oswego County Outbreak Investigation, 1940"
) |>
# Add spanners
tab_spanner(
label = md("**Ate Food**"),
columns = c(Ill_exposed, NotIll_exposed, Total_exposed, AR_exposed)
) |>
tab_spanner(
label = md("**Did Not Eat Food**"),
columns = c(Ill_not_exposed, NotIll_not_exposed, Total_not_exposed, AR_not_exposed)
) |>
cols_label(
food_item = md("**Food Item**"),
Ill_exposed = md("**Ill**"),
NotIll_exposed = md("**Not Ill**"),
Total_exposed = md("**Total**"),
AR_exposed = md("**Attack<br> Rate (%)**"),
Ill_not_exposed = md("**Ill**"),
NotIll_not_exposed = md("**Not Ill**"),
Total_not_exposed = md("**Total**"),
AR_not_exposed = md("**Attack<br> Rate (%)**"),
Attack_Rate_Ratio = md("**Attack Rate<br> Ratio**")
) |>
fmt_number(
columns = c(AR_exposed, AR_not_exposed, Attack_Rate_Ratio),
decimals = 1
) |>
tab_source_note(
source_note = "AR = Attack Rate; Exposure = Ate the food (Y/N)"
) |>
opt_align_table_header(align = "left") |>
tab_options(
table.border.top.style = "solid",
table.border.bottom.style = "solid",
column_labels.border.bottom.style = "solid",
table_body.hlines.style = "none",
table_body.vlines.style = "none"
)
att_rat_summary |>
ggplot(aes(x = reorder(food_item, Attack_Rate_Ratio), y = Attack_Rate_Ratio)) +
geom_col(fill = "thistle",
color = "black") +
coord_flip() +
labs(y = "Attack Rate Ratio", x = "Food Item")+
theme(panel.background = element_blank(),
axis.line.x = element_line(),
panel.grid.major.x = element_line(color = "grey",
size = 0.04)
)
### Stratied by Sex
# Step 1: Pivot foods to long format
att_rat_data_long <- data_clean |>
pivot_longer(
cols = baked.ham:fruit.salad,   # all food columns
names_to = "food_item",
values_to = "exposed"
)
# Step 2: Calculate stratified attack rates by sex
att_rat_sex <- att_rat_data_long |>
group_by(food_item, sex) |>
summarise(
Ill_exposed = sum(exposed == "Y" & ill == 1, na.rm = TRUE),
NotIll_exposed = sum(exposed == "Y" & ill == 0, na.rm = TRUE),
Ill_not_exposed = sum(exposed == "N" & ill == 1, na.rm = TRUE),
NotIll_not_exposed = sum(exposed == "N" & ill == 0, na.rm = TRUE),
Total_exposed = Ill_exposed + NotIll_exposed,
Total_not_exposed = Ill_not_exposed + NotIll_not_exposed,
AR_exposed = round(Ill_exposed / Total_exposed * 100, 1),
AR_not_exposed = round(Ill_not_exposed / Total_not_exposed * 100, 1),
Attack_Rate_Ratio = round(AR_exposed / AR_not_exposed, 2),
.groups = "drop"
) |>
arrange(food_item, sex)
# Create a named vector for nicer food names
food_names <- c(
"baked.ham" = "Baked Ham",
"brown.bread" = "Brown Bread",
"cabbage.salad" = "Cabbage Salad",
"cakes" = "Cakes",
"chocolate.ice.cream" = "Chocolate Ice Cream",
"coffee" = "Coffee",
"fruit.salad" = "Fruit Salad",
"jello" = "Jello",
"mashed.potato" = "Mashed Potato",
"milk" = "Milk",
"rolls" = "Rolls",
"spinach" = "Spinach",
"vanilla.ice.cream" = "Vanilla Ice Cream",
"water" = "Water"
)
# Apply nicer names to your table
att_rat_sex <- att_rat_sex |>
mutate(food_item = food_names[food_item])
# Step 3: Create a publication-ready table with gt
att_rat_sex |>
gt() |>
tab_header(
title = md("**Stratified Food-specific Attack Rates by Sex**"),
subtitle = "Oswego-style Outbreak Analysis"
) |>
tab_spanner(
label = md("**Ate Food**"),
columns = c(Ill_exposed, NotIll_exposed, Total_exposed, AR_exposed)
) |>
tab_spanner(
label = md("**Did Not Eat Food**"),
columns = c(Ill_not_exposed, NotIll_not_exposed, Total_not_exposed, AR_not_exposed)
) |>
cols_label(
food_item = md("**Food Item**"),
sex = "Sex",
Ill_exposed = md("**Ill**"),
NotIll_exposed =md("**Not Ill**"),
Total_exposed = md("**Total**"),
AR_exposed = md("**Attack<br> Rate (%)**"),
Ill_not_exposed = md("**Ill**"),
NotIll_not_exposed = md("**Not Ill**"),
Total_not_exposed = md("**Total**"),
AR_not_exposed = md("**Attack <br>Rate (%)**"),
Attack_Rate_Ratio = md("**Attack <br>Rate Ratio**")
) |>
fmt_number(
columns = c(AR_exposed, AR_not_exposed, Attack_Rate_Ratio),
decimals = 1
) |>
tab_source_note(
source_note = "AR = Attack Rate; Exposure = Ate the food (Y/N)"
) |>
tab_options(
table.border.top.style = "solid",
table.border.bottom.style = "solid",
column_labels.border.bottom.style = "solid",
table_body.hlines.style = "none",
table_body.vlines.style = "none"
)
